# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2.1

jobs:
    build:
        docker:
         # Use the same Docker base as the project
            - image: python:3.7.3-stretch

        working_directory: ~/repo

        steps:
            - checkout

            # Download and cache dependencies
            - restore_cache:
                keys:
                    - v1-dependencies-{{ checksum "requirements.txt" }}
                    # fallback to using the latest cache if no exact match is found
                    - v1-dependencies-

            - run:
                name: install dependencies
                command: |
                    python3 -m venv capstone
                    . capstone/bin/activate
                    make install

            - save_cache:
                paths:
                    - ./capstone
                key: v1-dependencies-{{ checksum "requirements.txt" }}

                # run lint!
            - run:
                name: run lint
                command: |
                    . capstone/bin/activate
                    make lint

    build_docker_image:
        docker:
            # Use the same Docker base as the project
            - image: amazon/aws-cli

        steps:
            - checkout
            - run:
                name: build image
                command: |
                    #install docker
                    yum -y install docker
                    #build docker image
                    docker build . --tag capstone
                    #list docker images
                    docker images capstone
                    #run the docker
                    docker run -p 80:5000 capstone 

workflows:
    default:
        jobs:
            - build
            - build_docker_image:
                requires: [ build ]